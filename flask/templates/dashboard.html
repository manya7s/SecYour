<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PhishSafe Analytics Dashboard</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    :root {
      --primary: #2c5aa0;
      --primary-light: #5a8ec9;
      --primary-dark: #1a3c6e;
      --secondary: #4caf50;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --dark: #1a1a2e;
      --light: #f8f9fa;
      --gray: #6c757d;
      --glass: rgba(255, 255, 255, 0.15);
      --card-bg: rgba(255, 255, 255, 0.85);
      --sidebar-width: 280px;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      --glass-blur: blur(10px);
    }

    .dark-mode {
      --primary: #5a8ec9;
      --primary-light: #7ba9db;
      --primary-dark: #2c5aa0;
      --dark: #f8f9fa;
      --light: #1a1a2e;
      --gray: #adb5bd;
      --glass: rgba(26, 26, 46, 0.7);
      --card-bg: rgba(26, 26, 46, 0.85);
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .glass-effect {
      --glass: rgba(255, 255, 255, 0.2);
      --card-bg: rgba(255, 255, 255, 0.7);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .dark-mode.glass-effect {
      --glass: rgba(26, 26, 46, 0.5);
      --card-bg: rgba(26, 26, 46, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      transition: var(--transition);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--glass);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      padding: 20px 0;
      position: fixed;
      height: 100vh;
      z-index: 100;
      transition: var(--transition);
      overflow-y: auto;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header h2 {
      margin-left: 10px;
      font-weight: 600;
      color: var(--primary);
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      margin: 5px 0;
      cursor: pointer;
      transition: var(--transition);
      border-left: 3px solid transparent;
    }

    .menu-item:hover, .menu-item.active {
      background: rgba(44, 90, 160, 0.1);
      border-left: 3px solid var(--primary);
    }

    .menu-item .material-icons {
      margin-right: 10px;
      font-size: 20px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: var(--transition);
    }

    /* Tab Content */
    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease-in-out;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .search-bar {
      display: flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 12px;
      width: 300px;
    }

    .search-bar input {
      border: none;
      background: transparent;
      margin-left: 8px;
      width: 100%;
      outline: none;
      color: var(--dark);
    }

    .user-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle, .glass-toggle {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .theme-toggle:hover, .glass-toggle:hover {
      background: rgba(44, 90, 160, 0.1);
    }

    .notification-badge {
      position: relative;
      cursor: pointer;
    }

    .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: bold;
    }

    .user-profile {
      display: flex;
      align-items: center;
      cursor: pointer;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 10px;
      font-weight: 600;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      transition: var(--transition);
      cursor: pointer;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin: 5px 0;
    }

    .stat-title {
      color: var(--gray);
      font-size: 14px;
    }

    .trend {
      display: flex;
      align-items: center;
      font-size: 12px;
      margin-top: 5px;
    }

    .trend.up {
      color: var(--success);
    }

    .trend.down {
      color: var(--danger);
    }

    /* Dashboard Content */
    .dashboard-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-weight: 600;
      font-size: 18px;
    }

    .card-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    /* User Logs */
    .user-logs {
      margin-top: 30px;
    }

    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .filters {
      display: flex;
      gap: 10px;
    }

    .filter-btn {
      background: rgba(44, 90, 160, 0.1);
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--dark);
      font-size: 14px;
    }

    .filter-btn:hover {
      background: rgba(44, 90, 160, 0.2);
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
    }

    .filter-btn .material-icons {
      font-size: 16px;
      margin-right: 5px;
    }

    /* Advanced Filters */
    .advanced-filters {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      display: none;
    }

    .advanced-filters.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    .filter-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: var(--gray);
    }

    .filter-input, .filter-select {
      width: 100%;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(44, 90, 160, 0.2);
      background: rgba(255, 255, 255, 0.2);
      color: var(--dark);
      font-family: 'Inter', sans-serif;
      transition: var(--transition);
    }

    .filter-input:focus, .filter-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(44, 90, 160, 0.2);
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    /* User Card */
    .user-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      transition: var(--transition);
      border-left: 4px solid transparent;
      cursor: pointer;
      opacity: 0;
      transform: translateY(20px);
      animation: cardEnter 0.4s ease-out forwards;
    }

    @keyframes cardEnter {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .user-card.normal {
      border-left-color: var(--success);
    }

    .user-card.warning {
      border-left-color: var(--warning);
    }

    .user-card.alert {
      border-left-color: var(--danger);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .user-title {
      font-weight: 600;
      display: flex;
      align-items: center;
    }

    .user-status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .user-status.normal {
      background: rgba(76, 175, 80, 0.2);
      color: var(--success);
    }

    .user-status.warning {
      background: rgba(255, 152, 0, 0.2);
      color: var(--warning);
    }

    .user-status.alert {
      background: rgba(244, 67, 54, 0.2);
      color: var(--danger);
    }

    .user-meta {
      display: flex;
      align-items: center;
      color: var(--gray);
      font-size: 14px;
    }

    .user-meta .material-icons {
      font-size: 16px;
      margin-right: 5px;
    }

    .user-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .user-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .user-stat {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .user-stat-value {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .user-stat-label {
      font-size: 12px;
      color: var(--gray);
    }

    /* Risk Score Gauge */
    .risk-gauge {
      width: 120px;
      height: 120px;
      position: relative;
      margin: 0 auto 15px;
    }

    .gauge-bg {
      fill: none;
      stroke: #eee;
      stroke-width: 10;
    }

    .gauge-fill {
      fill: none;
      stroke: var(--primary);
      stroke-width: 10;
      stroke-linecap: round;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 1s ease-in-out;
    }

    .gauge-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 700;
      font-size: 24px;
    }

    .gauge-label {
      text-align: center;
      font-size: 14px;
      color: var(--gray);
    }

    /* Low risk score animation */
    .risk-gauge.low-risk .gauge-fill {
      animation: pulseGauge 2s infinite;
    }

    @keyframes pulseGauge {
      0% { stroke: var(--primary); }
      50% { stroke: var(--success); }
      100% { stroke: var(--primary); }
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 20px;
      margin: 20px 0;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--primary);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
      padding-left: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -9px;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
    }

    .timeline-time {
      font-size: 12px;
      color: var(--gray);
      margin-bottom: 5px;
    }

    .timeline-content {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 10px;
    }

    .timeline-action {
      font-weight: 600;
      margin-bottom: 5px;
    }

    .timeline-details {
      display: flex;
      gap: 5px;
      font-size: 12px;
    }

    .timeline-detail {
      background: rgba(44, 90, 160, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Transaction Heatmap */
    .heatmap {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      margin-top: 15px;
    }

    .heatmap-cell {
      height: 30px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      font-weight: 600;
      position: relative;
      overflow: hidden;
    }

    .heatmap-trend {
      position: absolute;
      bottom: 2px;
      right: 2px;
      font-size: 10px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      animation: fadeIn 0.3s ease-in-out;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      max-width: 900px;
      max-height: 80vh;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-title {
      font-weight: 600;
      font-size: 20px;
    }

    .modal-close {
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: rgba(44, 90, 160, 0.1);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding-right: 10px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: rgba(44, 90, 160, 0.1);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #d90429;
    }

    /* JSON Viewer */
    .json-viewer {
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 8px;
      padding: 15px;
      max-height: 60vh;
      overflow-y: auto;
    }

    /* Analytics Page */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .analytics-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
    }

    .analytics-card.wide {
      grid-column: span 2;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .dashboard-content, .analytics-grid {
        grid-template-columns: 1fr;
      }
      .analytics-card.wide {
        grid-column: span 1;
      }
    }

    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
        z-index: 1000;
      }
      .sidebar.active {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
      .menu-toggle {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .user-body {
        grid-template-columns: 1fr;
      }
      .user-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      .search-bar {
        width: 200px;
      }
      .modal-content {
        width: 95%;
      }
      .top-bar {
        flex-direction: column;
        gap: 10px;
      }
      .user-actions {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 576px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .search-bar {
        width: 100%;
      }
      .filters {
        flex-wrap: wrap;
      }
      .filter-row {
        flex-direction: column;
        gap: 10px;
      }
      .filter-group {
        min-width: 100%;
      }
    }

    /* Bottom Navbar for Mobile */
    .bottom-navbar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--card-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
      padding: 10px 0;
    }

    .bottom-navbar .nav-items {
      display: flex;
      justify-content: space-around;
    }

    .bottom-navbar .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: var(--gray);
      font-size: 12px;
      transition: var(--transition);
    }

    .bottom-navbar .nav-item.active {
      color: var(--primary);
    }

    .bottom-navbar .nav-item .material-icons {
      font-size: 24px;
      margin-bottom: 2px;
    }

    @media (max-width: 768px) {
      .bottom-navbar {
        display: block;
      }
      .main-content {
        padding-bottom: 70px;
      }
    }

    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
      margin-left: 10px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: var(--primary);
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* Tooltip */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark);
      color: var(--light);
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 12px;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }

    /* Status icons */
    .status-icon {
      margin-right: 5px;
      font-size: 14px;
    }

    .user-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border-left: 4px solid transparent;
    }

    .user-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .user-meta span {
      margin-right: 10px;
      display: inline-flex;
      align-items: center;
    }

    .badge-pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(44, 90, 160, 0.1);
      margin-left: 6px;
    }

    /* Mini map styling */
    .user-location-map {
      height: 150px;
      border-radius: 8px;
      margin-top: 12px;
      box-shadow: var(--shadow);
    }

  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <span class="material-icons" style="color: var(--primary); font-size: 28px;">security</span>
      <h2>PhishSafe Analytics</h2>
    </div>
    <div class="sidebar-menu">
      <div class="menu-item active" data-tab="dashboard">
        <span class="material-icons">dashboard</span>
        Dashboard
      </div>
      <div class="menu-item" data-tab="sessions">
        <span class="material-icons">analytics</span>
        Session Analytics
      </div>
      <div class="menu-item" data-tab="devices">
        <span class="material-icons">devices</span>
        Devices
      </div>
      <div class="menu-item" data-tab="behavior">
        <span class="material-icons">psychology</span>
        Behavior Analysis
      </div>
      <div class="menu-item" data-tab="reports">
        <span class="material-icons">description</span>
        Reports
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="search-bar">
        <span class="material-icons">search</span>
        <input type="text" placeholder="Search sessions, devices, users..." id="searchInput">
      </div>
      <div class="user-actions">
        <div class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
          <span class="material-icons">brightness_4</span>
        </div>
        <div class="glass-toggle" id="glassToggle" title="Toggle Glass Effect">
          <span class="material-icons">blur_on</span>
        </div>
        <div class="notification-badge">
          <span class="material-icons">notifications</span>
          <div class="badge" id="notificationCount">0</div>
        </div>
        <div class="user-profile">
          <div class="user-avatar">PS</div>
          <span>Analyst</span>
        </div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div class="tab-content active" id="dashboard-tab">
      <!-- Stats Grid -->
      <div class="stats-grid" id="statsGrid">
        <!-- Stats will be populated by JavaScript -->
      </div>

      <!-- Dashboard Content -->
      <div class="dashboard-content">
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Trust Score Distribution</div>
            <div class="card-actions">
              <button class="filter-btn" id="timeFilter">
                <span class="material-icons">calendar_today</span>
                Last 7 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="trustScoreChart"></div>
          </div>
        </div>
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Device Platform Distribution</div>
            <div class="card-actions">
              <button class="filter-btn active" id="refreshBtn">
                <span class="material-icons">refresh</span>
                Live
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="deviceChart"></div>
          </div>
        </div>
      </div>

      <!-- Recent Sessions -->
      <div class="user-logs">
        <div class="logs-header">
          <h3>Recent Sessions</h3>
          <div class="filters">
            <button class="filter-btn" id="filterBtn">
              <span class="material-icons">filter_list</span>
              Filters
            </button>
            <button class="filter-btn" id="exportBtn">
              <span class="material-icons">download</span>
              Export
            </button>
            <div class="tooltip">
              <button class="filter-btn active" id="autoRefreshBtn">
                <span class="material-icons">autorenew</span>
                Auto-refresh
                <span id="lastUpdatedTime"></span>
              </button>
              <span class="tooltiptext">Automatically refresh session data every 30 seconds</span>
            </div>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" id="advancedFilters">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Date Range</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" class="filter-input" id="dateFrom">
                <input type="date" class="filter-input" id="dateTo">
              </div>
            </div>
            <div class="filter-group">
              <label class="filter-label">Trust Score</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" class="filter-input" id="trustScoreRange" min="0" max="100" value="70">
                <span id="trustScoreValue">70+</span>
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Platform</label>
              <select class="filter-select" id="platformType">
                <option value="">All Platforms</option>
                <option value="Android">Android</option>
                <option value="iOS">iOS</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Risk Level</label>
              <select class="filter-select" id="riskLevel">
                <option value="">All Levels</option>
                <option value="low">Low Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="high">High Risk</option>
              </select>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-outline" id="resetFilters">
              <span class="material-icons">clear</span>
              Reset
            </button>
            <button class="btn btn-primary" id="applyFilters">
              <span class="material-icons">check</span>
              Apply Filters
            </button>
          </div>
        </div>

        <!-- Session Cards Container -->
        <div id="sessionCardsContainer">
          <!-- Session cards will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Sessions Tab -->
    <div class="tab-content" id="sessions-tab">
      <div class="user-logs">
        <div class="logs-header">
          <h3>All Sessions</h3>
          <div class="filters">
            <button class="filter-btn" id="sessionsFilterBtn">
              <span class="material-icons">filter_list</span>
              Filters
            </button>
            <button class="filter-btn" id="sessionsExportBtn">
              <span class="material-icons">download</span>
              Export
            </button>
          </div>
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters" id="sessionsAdvancedFilters">
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Session Date</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" class="filter-input" id="sessionsDateFrom">
                <input type="date" class="filter-input" id="sessionsDateTo">
              </div>
            </div>
            <div class="filter-group">
              <label class="filter-label">Trust Score</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="range" class="filter-input" id="sessionsTrustScoreRange" min="0" max="100" value="70">
                <span id="sessionsTrustScoreValue">70+</span>
              </div>
            </div>
          </div>
          <div class="filter-row">
            <div class="filter-group">
              <label class="filter-label">Platform</label>
              <select class="filter-select" id="sessionsPlatform">
                <option value="">All Platforms</option>
                <option value="Android">Android</option>
                <option value="iOS">iOS</option>
              </select>
            </div>
            <div class="filter-group">
              <label class="filter-label">Duration (seconds)</label>
              <div style="display: flex; gap: 10px;">
                <input type="number" class="filter-input" id="durationFrom" placeholder="Min">
                <input type="number" class="filter-input" id="durationTo" placeholder="Max">
              </div>
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-outline" id="sessionsResetFilters">
              <span class="material-icons">clear</span>
              Reset
            </button>
            <button class="btn btn-primary" id="sessionsApplyFilters">
              <span class="material-icons">check</span>
              Apply Filters
            </button>
          </div>
        </div>

        <!-- Sessions Table -->
        <div class="chart-card">
          <div class="card-header">
            <div class="card-title">Session List</div>
            <div class="card-actions">
              <div class="tooltip">
                <button class="filter-btn" id="selectAllBtn">
                  <span class="material-icons">select_all</span>
                  Select All
                </button>
                <span class="tooltiptext">Select all filtered sessions</span>
              </div>
            </div>
          </div>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(44, 90, 160, 0.1);">
                  <th style="padding: 12px 15px; text-align: left;">Session ID</th>
                  <th style="padding: 12px 15px; text-align: left;">Device</th>
                  <th style="padding: 12px 15px; text-align: left;">Platform</th>
                  <th style="padding: 12px 15px; text-align: left;">Trust Score</th>
                  <th style="padding: 12px 15px; text-align: left;">Duration</th>
                  <th style="padding: 12px 15px; text-align: left;">Date</th>
                  <th style="padding: 12px 15px; text-align: left;">Actions</th>
                </tr>
              </thead>
              <tbody id="sessionsTableBody">
                <!-- Sessions will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="font-size: 14px; color: var(--gray);">
              Showing <span id="showingCount">0</span> of <span id="totalCount">0</span> sessions
            </div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-outline" id="prevPageBtn" disabled>
                <span class="material-icons">chevron_left</span>
                Previous
              </button>
              <button class="btn btn-outline" id="nextPageBtn" disabled>
                Next
                <span class="material-icons">chevron_right</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Devices Tab -->
    <div class="tab-content" id="devices-tab">
      <div class="analytics-grid">
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Device Distribution</div>
            <div class="card-actions">
              <button class="filter-btn" id="deviceTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 30 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="deviceDistributionChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Android Version Distribution</div>
          </div>
          <div class="chart-container">
            <div id="androidVersionChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Device Manufacturers</div>
          </div>
          <div class="chart-container">
            <div id="manufacturerChart"></div>
          </div>
        </div>
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Device Trust Score Over Time</div>
            <div class="card-actions">
              <button class="filter-btn" id="deviceScoreTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 14 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="deviceScoreChart"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Behavior Analysis Tab -->
    <div class="tab-content" id="behavior-tab">
      <div class="analytics-grid">
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Behavior Pattern Analysis</div>
            <div class="card-actions">
              <button class="filter-btn" id="behaviorTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 30 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="behaviorPatternChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Tap Duration Distribution</div>
          </div>
          <div class="chart-container">
            <div id="tapDurationChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Swipe Speed Analysis</div>
          </div>
          <div class="chart-container">
            <div id="swipeSpeedChart"></div>
          </div>
        </div>
        <div class="analytics-card wide">
          <div class="card-header">
            <div class="card-title">Penalty Analysis</div>
            <div class="card-actions">
              <button class="filter-btn" id="penaltyTimeFilter">
                <span class="material-icons">calendar_today</span>
                Last 14 days
              </button>
            </div>
          </div>
          <div class="chart-container">
            <div id="penaltyChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Screen Zone Analysis</div>
          </div>
          <div class="chart-container">
            <div id="screenZoneChart"></div>
          </div>
        </div>
        <div class="analytics-card">
          <div class="card-header">
            <div class="card-title">Session Duration Analysis</div>
          </div>
          <div class="chart-container">
            <div id="sessionDurationChart"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" id="reports-tab">
      <div class="user-logs">
        <div class="logs-header">
          <h3>Reports & Analytics</h3>
          <div class="filters">
            <button class="btn btn-primary" id="generateReportBtn">
              <span class="material-icons">summarize</span>
              Generate Report
            </button>
            <button class="filter-btn" id="scheduleReportBtn">
              <span class="material-icons">schedule</span>
              Schedule Report
            </button>
          </div>
        </div>

        <div class="analytics-grid">
          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Daily Activity Report</div>
              <div class="card-actions">
                <button class="filter-btn">
                  <span class="material-icons">download</span>
                  PDF
                </button>
              </div>
            </div>
            <div style="padding: 15px;">
              <p>Summary of all user activities for the current day.</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Total Sessions:</span>
                  <span style="font-weight: 600;" id="dailySessions">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Average Trust Score:</span>
                  <span style="font-weight: 600;" id="dailyTrustScore">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>High Risk Sessions:</span>
                  <span style="font-weight: 600; color: var(--danger);" id="dailyHighRisk">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>New Devices:</span>
                  <span style="font-weight: 600;" id="dailyNewDevices">0</span>
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Weekly Security Report</div>
              <div class="card-actions">
                <button class="filter-btn">
                  <span class="material-icons">download</span>
                  PDF
                </button>
              </div>
            </div>
            <div style="padding: 15px;">
              <p>Security overview for the current week.</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Total Penalties:</span>
                  <span style="font-weight: 600;" id="weeklyPenalties">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Screen Recording Detected:</span>
                  <span style="font-weight: 600;" id="weeklyScreenRecording">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Average Session Duration:</span>
                  <span style="font-weight: 600;" id="weeklyAvgDuration">0</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Most Common Penalty:</span>
                  <span style="font-weight: 600;" id="weeklyCommonPenalty">None</span>
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-card">
            <div class="card-header">
              <div class="card-title">Monthly Analytics Report</div>
              <div class="card-actions">
                <button class="filter-btn">
                  <span class="material-icons">download</span>
                  PDF
                </button>
              </div>
            </div>
            <div style="padding: 15px;">
              <p>Monthly behavioral analytics and trends.</p>
              <div style="margin-top: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Total Sessions:</span>
                  <span style="font-weight: 600;" id="monthlySessions">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Most Used Device:</span>
                  <span style="font-weight: 600;" id="monthlyTopDevice">None</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                  <span>Trust Score Trend:</span>
                  <span style="font-weight: 600; color: var(--success);" id="monthlyTrustTrend">+0%</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>Geographic Distribution:</span>
                  <span style="font-weight: 600;" id="monthlyGeoDistribution">0 locations</span>
                </div>
              </div>
            </div>
          </div>

          <div class="analytics-card wide">
            <div class="card-header">
              <div class="card-title">Custom Report Builder</div>
            </div>
            <div style="padding: 15px;">
              <div class="filter-row">
                <div class="filter-group">
                  <label class="filter-label">Report Type</label>
                  <select class="filter-select">
                    <option value="activity">Session Activity</option>
                    <option value="security">Security</option>
                    <option value="device">Device Analytics</option>
                    <option value="behavior">Behavior Analysis</option>
                    <option value="custom">Custom</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">Date Range</label>
                  <select class="filter-select">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="quarter">This Quarter</option>
                    <option value="year">This Year</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
              </div>
              <div class="filter-row">
                <div class="filter-group">
                  <label class="filter-label">Format</label>
                  <select class="filter-select">
                    <option value="pdf">PDF</option>
                    <option value="excel">Excel</option>
                    <option value="csv">CSV</option>
                  </select>
                </div>
                <div class="filter-group">
                  <label class="filter-label">Include Charts</label>
                  <label class="switch">
                    <input type="checkbox" checked>
                    <span class="slider"></span>
                  </label>
                </div>
              </div>
              <div class="filter-actions">
                <button class="btn btn-primary">
                  <span class="material-icons">summarize</span>
                  Generate Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navbar for Mobile -->
  <div class="bottom-navbar">
    <div class="nav-items">
      <a href="#" class="nav-item active" data-tab="dashboard">
        <span class="material-icons">dashboard</span>
        Dashboard
      </a>
      <a href="#" class="nav-item" data-tab="sessions">
        <span class="material-icons">analytics</span>
        Sessions
      </a>
      <a href="#" class="nav-item" data-tab="devices">
        <span class="material-icons">devices</span>
        Devices
      </a>
      <a href="#" class="nav-item" data-tab="behavior">
        <span class="material-icons">psychology</span>
        Behavior
      </a>
      <a href="#" class="nav-item" data-tab="reports">
        <span class="material-icons">description</span>
        Reports
      </a>
    </div>
  </div>

  <!-- Session Details Modal -->
  <div class="modal" id="sessionModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Session Details</div>
        <div class="modal-close" id="modalClose">
          <span class="material-icons">close</span>
        </div>
      </div>
      <div class="modal-body">
        <div class="json-viewer" id="sessionJsonViewer"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="copyJsonBtn">
          <span class="material-icons">content_copy</span>
          Copy JSON
        </button>
        <button class="btn btn-primary" id="closeModalBtn">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    // Theme Toggle
    const themeToggle = document.getElementById('themeToggle');
    const glassToggle = document.getElementById('glassToggle');
    const body = document.body;
    
    // Check for saved theme preference
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      body.classList.add('dark-mode');
      themeToggle.innerHTML = '<span class="material-icons">brightness_7</span>';
    }
    
    // Check for glass effect preference
    const savedGlassEffect = localStorage.getItem('glassEffect');
    if (savedGlassEffect === 'true') {
      body.classList.add('glass-effect');
      glassToggle.innerHTML = '<span class="material-icons">blur_off</span>';
    }
    
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      
      // Save preference
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update icon
      themeToggle.innerHTML = isDark 
        ? '<span class="material-icons">brightness_7</span>' 
        : '<span class="material-icons">brightness_4</span>';
    });
    
    glassToggle.addEventListener('click', () => {
      body.classList.toggle('glass-effect');
      const hasGlassEffect = body.classList.contains('glass-effect');
      
      // Save preference
      localStorage.setItem('glassEffect', hasGlassEffect ? 'true' : 'false');
      
      // Update icon
      glassToggle.innerHTML = hasGlassEffect 
        ? '<span class="material-icons">blur_off</span>' 
        : '<span class="material-icons">blur_on</span>';
    });

    // Tab Navigation
    const menuItems = document.querySelectorAll('.menu-item');
    const tabContents = document.querySelectorAll('.tab-content');
    const navItems = document.querySelectorAll('.nav-item');
    
    function setActiveTab(tabId) {
      // Update menu items
      menuItems.forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabId);
      });
      
      // Update tab contents
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === `${tabId}-tab`);
      });
      
      // Update bottom nav items
      navItems.forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tabId);
      });
      
      // Store active tab
      localStorage.setItem('activeTab', tabId);
      
      // Load data if needed
      if (tabId === 'sessions') {
        loadSessionsTable();
      } else if (tabId === 'devices') {
        loadDeviceAnalytics();
      } else if (tabId === 'behavior') {
        loadBehaviorAnalytics();
      } else if (tabId === 'reports') {
        loadReportData();
      }
    }
    
    // Add click event to menu items
    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        setActiveTab(item.dataset.tab);
      });
    });
    
    // Add click event to bottom nav items
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        setActiveTab(item.dataset.tab);
      });
    });
    
    // Check for saved active tab
    const savedActiveTab = localStorage.getItem('activeTab') || 'dashboard';
    setActiveTab(savedActiveTab);

    // Global variables
    let allSessions = [];
    let filteredSessions = [];
    let autoRefreshInterval;
    let currentPage = 1;
    const itemsPerPage = 10;
    let selectedSessions = new Set();

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadSessionData();
      setupEventListeners();
      
      // Set up auto-refresh
      startAutoRefresh();
      
      // Set up keyboard shortcuts
      setupKeyboardShortcuts();
      
      // Update last updated time
      updateLastUpdatedTime();
    });

    // Update last updated time
    function updateLastUpdatedTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('lastUpdatedTime').textContent = `Last updated: ${timeString}`;
    }

    // Load session data from the Flask server
    async function loadSessionData() {
      try {
        const response = await fetch('/logs');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allSessions = data.logs || [];
        filteredSessions = [...allSessions];
        
        updateStats(allSessions);
        updateCharts(allSessions);
        renderSessionCards(allSessions);
        
        // Update notification count
        const highRiskSessions = allSessions.filter(session => {
          const trustScore = parseFloat(session.content.session.trust_score);
          return trustScore < 70;
        }).length;
        
        document.getElementById('notificationCount').textContent = highRiskSessions;
        
        // Update last updated time
        updateLastUpdatedTime();
        
        // Cache the data
        localStorage.setItem('cachedSessions', JSON.stringify(allSessions));
        localStorage.setItem('lastUpdated', new Date().getTime());
      } catch (error) {
        console.error('Error loading session data:', error);
        
        // Try to load cached data if available
        const cachedSessions = localStorage.getItem('cachedSessions');
        if (cachedSessions) {
          allSessions = JSON.parse(cachedSessions);
          filteredSessions = [...allSessions];
          updateStats(allSessions);
          updateCharts(allSessions);
          renderSessionCards(allSessions);
          
          Swal.fire({
            icon: 'warning',
            title: 'Using Cached Data',
            text: 'Failed to fetch new data. Displaying cached session information.',
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to load session data. Please try again later.',
          });
        }
      }
    }

    // Update stats cards
    function updateStats(sessions) {
      const statsGrid = document.getElementById('statsGrid');
      
      // Calculate stats
      const totalSessions = sessions.length;
      
      let totalTrustScore = 0;
      let highRiskSessions = 0;
      let totalDuration = 0;
      let uniqueDevices = new Set();
      
      sessions.forEach(session => {
        const trustScore = parseFloat(session.content.session.trust_score);
        totalTrustScore += trustScore;
        
        if (trustScore < 70) {
          highRiskSessions++;
        }
        
        totalDuration += session.content.session.duration_seconds;
        
        const deviceKey = `${session.content.device.brand}-${session.content.device.model}`;
        uniqueDevices.add(deviceKey);
      });
      
      const avgTrustScore = totalSessions > 0 ? (totalTrustScore / totalSessions).toFixed(2) : 0;
      const avgDuration = totalSessions > 0 ? (totalDuration / totalSessions).toFixed(2) : 0;
      const uniqueDeviceCount = uniqueDevices.size;
      
      // Create stats HTML
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Total Sessions</div>
              <div class="stat-value" id="totalSessionsCounter">0</div>
            </div>
            <div class="stat-icon" style="background: var(--primary);">
              <span class="material-icons">analytics</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(totalSessions * 0.05)} new today</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Avg. Trust Score</div>
              <div class="stat-value" id="avgTrustScoreCounter">0</div>
            </div>
            <div class="stat-icon" style="background: var(--success);">
              <span class="material-icons">security</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(avgTrustScore * 0.08)}% from yesterday</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Avg. Duration</div>
              <div class="stat-value" id="avgDurationCounter">0s</div>
            </div>
            <div class="stat-icon" style="background: var(--primary-dark);">
              <span class="material-icons">timer</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(avgDuration * 0.02)}% from yesterday</span>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div>
              <div class="stat-title">Unique Devices</div>
              <div class="stat-value" id="uniqueDevicesCounter">0</div>
            </div>
            <div class="stat-icon" style="background: var(--warning);">
              <span class="material-icons">devices</span>
            </div>
          </div>
          <div class="trend up">
            <span class="material-icons">trending_up</span>
            <span>${Math.floor(uniqueDeviceCount * 0.05)} new this week</span>
          </div>
        </div>
      `;
      
      // Animate counters
      animateCounter('totalSessionsCounter', totalSessions, 0);
      animateCounter('avgTrustScoreCounter', avgTrustScore, 0);
      animateCounter('avgDurationCounter', avgDuration, 0, '', 's');
      animateCounter('uniqueDevicesCounter', uniqueDeviceCount, 0);
    }

    // Animate counter
    function animateCounter(elementId, target, current, prefix = '', suffix = '') {
      const element = document.getElementById(elementId);
      const increment = target / 50; // Adjust speed of animation
      
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          clearInterval(timer);
          current = target;
        }
        
        if (prefix === '$') {
          element.textContent = prefix + Math.round(current).toLocaleString() + suffix;
        } else {
          element.textContent = prefix + Math.round(current * 100) / 100 + suffix;
        }
      }, 20);
    }

    // Update charts
    let deviceChartInstance;
    let trustScoreChartInstance;

    function updateCharts(sessions) {
      // Trust Score Distribution Chart
      const trustScoreBins = Array(10).fill(0);
      sessions.forEach(session => {
        const trustScore = parseFloat(session.content.session.trust_score);
        const bin = Math.floor(trustScore / 10);
        trustScoreBins[bin === 10 ? 9 : bin]++;
      });
      
      const trustScoreChartOptions = {
        series: [{
          name: 'Sessions',
          data: trustScoreBins
        }],
        chart: {
          height: 300,
          type: 'bar',
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90', '90-100']
        },
        colors: ['#2c5aa0'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      if (trustScoreChartInstance) trustScoreChartInstance.destroy();
      trustScoreChartInstance = new ApexCharts(document.querySelector("#trustScoreChart"), trustScoreChartOptions);
      trustScoreChartInstance.render();
      
      // Device Platform Chart
      const platformCounts = {};
      sessions.forEach(session => {
        const platform = session.content.device.platform;
        platformCounts[platform] = (platformCounts[platform] || 0) + 1;
      });
      
      const deviceChartOptions = {
        series: Object.values(platformCounts),
        chart: {
          type: 'donut',
          height: 300
        },
        colors: ['#2c5aa0', '#4caf50', '#ff9800', '#f44336'],
        labels: Object.keys(platformCounts),
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }],
        plotOptions: {
          pie: {
            donut: {
              size: '70%'
            }
          }
        },
        dataLabels: {
          enabled: false
        },
        legend: {
          position: 'right'
        },
        tooltip: {
          y: {
            formatter: function(value) {
              const total = Object.values(platformCounts).reduce((a, b) => a + b, 0);
              const percentage = Math.round((value / total) * 100);
              return `${value} sessions (${percentage}%)`;
            }
          }
        }
      };
      
      if (deviceChartInstance) deviceChartInstance.destroy();
      deviceChartInstance = new ApexCharts(document.querySelector("#deviceChart"), deviceChartOptions);
      deviceChartInstance.render();
    }

    // Load device analytics
    function loadDeviceAnalytics() {
      if (allSessions.length === 0) return;
      
      // Device Distribution Chart
      const deviceDistribution = {};
      allSessions.forEach(session => {
        const deviceKey = `${session.content.device.brand} ${session.content.device.model}`;
        deviceDistribution[deviceKey] = (deviceDistribution[deviceKey] || 0) + 1;
      });
      
      const deviceDistributionChartOptions = {
        series: [{
          name: 'Sessions',
          data: Object.values(deviceDistribution)
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: true,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: Object.keys(deviceDistribution)
        },
        colors: ['#5a8ec9'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const deviceDistributionChart = new ApexCharts(document.querySelector("#deviceDistributionChart"), deviceDistributionChartOptions);
      deviceDistributionChart.render();
      
      // Android Version Distribution
      const androidVersions = {};
      allSessions.forEach(session => {
        if (session.content.device.platform === 'Android') {
          const version = session.content.device.version;
          androidVersions[version] = (androidVersions[version] || 0) + 1;
        }
      });
      
      const androidVersionChartOptions = {
        series: Object.values(androidVersions),
        chart: {
          type: 'pie',
          height: 300
        },
        labels: Object.keys(androidVersions),
        colors: ['#2c5aa0', '#4caf50', '#ff9800', '#f44336', '#9c27b0'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }],
        dataLabels: {
          enabled: false
        },
        legend: {
          position: 'right'
        }
      };
      
      const androidVersionChart = new ApexCharts(document.querySelector("#androidVersionChart"), androidVersionChartOptions);
      androidVersionChart.render();
      
      // Device Manufacturers
      const manufacturers = {};
      allSessions.forEach(session => {
        const manufacturer = session.content.device.manufacturer;
        manufacturers[manufacturer] = (manufacturers[manufacturer] || 0) + 1;
      });
      
      const manufacturerChartOptions = {
        series: [{
          name: 'Sessions',
          data: Object.values(manufacturers)
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: Object.keys(manufacturers)
        },
        colors: ['#ff9800'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const manufacturerChart = new ApexCharts(document.querySelector("#manufacturerChart"), manufacturerChartOptions);
      manufacturerChart.render();
      
      // Device Trust Score Over Time
      const last14Days = Array(14).fill().map((_, i) => {
        const date = new Date();
        date.setDate(date.getDate() - (13 - i));
        return date;
      });
      
      const avgTrustScores = last14Days.map(date => {
        const daySessions = allSessions.filter(s => {
          const sessionDate = new Date(s.content.session.start);
          return sessionDate.toDateString() === date.toDateString();
        });
        
        if (daySessions.length === 0) return 0;
        const totalTrust = daySessions.reduce((sum, s) => sum + parseFloat(s.content.session.trust_score), 0);
        return totalTrust / daySessions.length;
      });
      
      const deviceScoreChartOptions = {
        series: [{
          name: 'Average Trust Score',
          data: avgTrustScores
        }],
        chart: {
          height: 300,
          type: 'line',
          zoom: {
            enabled: false
          },
          toolbar: {
            show: false
          }
        },
        dataLabels: {
          enabled: false
        },
        stroke: {
          curve: 'smooth',
          width: 3
        },
        colors: ['#2c5aa0'],
        xaxis: {
          categories: last14Days.map(date => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        },
        yaxis: {
          min: 0,
          max: 100
        },
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value.toFixed(2)}`;
            }
          }
        }
      };
      
      const deviceScoreChart = new ApexCharts(document.querySelector("#deviceScoreChart"), deviceScoreChartOptions);
      deviceScoreChart.render();
    }

    // Load behavior analytics
    function loadBehaviorAnalytics() {
      if (allSessions.length === 0) return;
      
      // Behavior Pattern Analysis
      const behaviorPatterns = {
        'Very fast tap': 0,
        'Unusual swipe': 0,
        'Screen recording': 0,
        'Other': 0
      };
      
      allSessions.forEach(session => {
        if (session.content.behavior_analysis && session.content.behavior_analysis.length > 0) {
          session.content.behavior_analysis.forEach(behavior => {
            if (behavior.description.includes('fast tap')) {
              behaviorPatterns['Very fast tap']++;
            } else if (behavior.description.includes('swipe')) {
              behaviorPatterns['Unusual swipe']++;
            } else {
              behaviorPatterns['Other']++;
            }
          });
        }
        
        if (session.content.screen_recording_detected) {
          behaviorPatterns['Screen recording']++;
        }
      });
      
      const behaviorPatternChartOptions = {
        series: [{
          name: 'Occurrences',
          data: Object.values(behaviorPatterns)
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: Object.keys(behaviorPatterns)
        },
        colors: ['#2c5aa0'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} occurrences`;
            }
          }
        }
      };
      
      const behaviorPatternChart = new ApexCharts(document.querySelector("#behaviorPatternChart"), behaviorPatternChartOptions);
      behaviorPatternChart.render();
      
      // Tap Duration Distribution
      const tapDurations = [];
      allSessions.forEach(session => {
        if (session.content.tap_durations_ms) {
          tapDurations.push(...session.content.tap_durations_ms);
        }
      });
      
      // Group into bins
      const tapDurationBins = Array(5).fill(0);
      tapDurations.forEach(duration => {
        if (duration < 200) tapDurationBins[0]++;
        else if (duration < 400) tapDurationBins[1]++;
        else if (duration < 600) tapDurationBins[2]++;
        else if (duration < 800) tapDurationBins[3]++;
        else tapDurationBins[4]++;
      });
      
      const tapDurationChartOptions = {
        series: [{
          name: 'Taps',
          data: tapDurationBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-200ms', '200-400ms', '400-600ms', '600-800ms', '800+ms']
        },
        colors: ['#4caf50'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} taps`;
            }
          }
        }
      };
      
      const tapDurationChart = new ApexCharts(document.querySelector("#tapDurationChart"), tapDurationChartOptions);
      tapDurationChart.render();
      
      // Swipe Speed Analysis
      const swipeSpeeds = [];
      allSessions.forEach(session => {
        if (session.content.swipe_events) {
          session.content.swipe_events.forEach(swipe => {
            if (swipe.speed_px_per_ms) {
              swipeSpeeds.push(swipe.speed_px_per_ms);
            }
          });
        }
      });
      
      // Group into bins
      const swipeSpeedBins = Array(5).fill(0);
      swipeSpeeds.forEach(speed => {
        if (speed < 0.2) swipeSpeedBins[0]++;
        else if (speed < 0.4) swipeSpeedBins[1]++;
        else if (speed < 0.6) swipeSpeedBins[2]++;
        else if (speed < 0.8) swipeSpeedBins[3]++;
        else swipeSpeedBins[4]++;
      });
      
      const swipeSpeedChartOptions = {
        series: [{
          name: 'Swipes',
          data: swipeSpeedBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-0.2', '0.2-0.4', '0.4-0.6', '0.6-0.8', '0.8+ px/ms']
        },
        colors: ['#ff9800'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} swipes`;
            }
          }
        }
      };
      
      const swipeSpeedChart = new ApexCharts(document.querySelector("#swipeSpeedChart"), swipeSpeedChartOptions);
      swipeSpeedChart.render();
      
      // Penalty Analysis
      const penaltyTypes = {};
      allSessions.forEach(session => {
        if (session.content.behavior_analysis && session.content.behavior_analysis.length > 0) {
          session.content.behavior_analysis.forEach(behavior => {
            penaltyTypes[behavior.description] = (penaltyTypes[behavior.description] || 0) + 1;
          });
        }
      });
      
      const penaltyChartOptions = {
        series: [{
          name: 'Occurrences',
          data: Object.values(penaltyTypes)
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: true,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: Object.keys(penaltyTypes)
        },
        colors: ['#f44336'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} occurrences`;
            }
          }
        }
      };
      
      const penaltyChart = new ApexCharts(document.querySelector("#penaltyChart"), penaltyChartOptions);
      penaltyChart.render();
      
      // Screen Zone Analysis
      const screenZones = {};
      allSessions.forEach(session => {
        if (session.content.tap_events) {
          session.content.tap_events.forEach(tap => {
            if (tap.zone) {
              screenZones[tap.zone] = (screenZones[tap.zone] || 0) + 1;
            }
          });
        }
      });
      
      const screenZoneChartOptions = {
        series: [{
          name: 'Taps',
          data: Object.values(screenZones)
        }],
        chart: {
          type: 'polarArea',
          height: 300
        },
        labels: Object.keys(screenZones),
        colors: ['#2c5aa0', '#4caf50', '#ff9800', '#f44336', '#9c27b0'],
        responsive: [{
          breakpoint: 480,
          options: {
            chart: {
              width: 200
            },
            legend: {
              position: 'bottom'
            }
          }
        }],
        dataLabels: {
          enabled: false
        },
        legend: {
          position: 'right'
        }
      };
      
      const screenZoneChart = new ApexCharts(document.querySelector("#screenZoneChart"), screenZoneChartOptions);
      screenZoneChart.render();
      
      // Session Duration Analysis
      const sessionDurations = allSessions.map(session => session.content.session.duration_seconds);
      
      // Group into bins
      const sessionDurationBins = Array(5).fill(0);
      sessionDurations.forEach(duration => {
        if (duration < 10) sessionDurationBins[0]++;
        else if (duration < 30) sessionDurationBins[1]++;
        else if (duration < 60) sessionDurationBins[2]++;
        else if (duration < 120) sessionDurationBins[3]++;
        else sessionDurationBins[4]++;
      });
      
      const sessionDurationChartOptions = {
        series: [{
          name: 'Sessions',
          data: sessionDurationBins
        }],
        chart: {
          type: 'bar',
          height: 300,
          toolbar: {
            show: false
          }
        },
        plotOptions: {
          bar: {
            borderRadius: 4,
            horizontal: false,
          }
        },
        dataLabels: {
          enabled: false
        },
        xaxis: {
          categories: ['0-10s', '10-30s', '30-60s', '60-120s', '120+s']
        },
        colors: ['#9c27b0'],
        tooltip: {
          y: {
            formatter: function(value) {
              return `${value} sessions`;
            }
          }
        }
      };
      
      const sessionDurationChart = new ApexCharts(document.querySelector("#sessionDurationChart"), sessionDurationChartOptions);
      sessionDurationChart.render();
    }

    // Load report data
    function loadReportData() {
      if (allSessions.length === 0) return;
      
      // Daily stats
      const today = new Date();
      const todaySessions = allSessions.filter(session => {
        const sessionDate = new Date(session.content.session.start);
        return sessionDate.toDateString() === today.toDateString();
      });
      
      document.getElementById('dailySessions').textContent = todaySessions.length;
      
      if (todaySessions.length > 0) {
        const totalTrust = todaySessions.reduce((sum, session) => sum + parseFloat(session.content.session.trust_score), 0);
        const avgTrust = (totalTrust / todaySessions.length).toFixed(2);
        document.getElementById('dailyTrustScore').textContent = avgTrust;
        
        const highRisk = todaySessions.filter(session => parseFloat(session.content.session.trust_score) < 70).length;
        document.getElementById('dailyHighRisk').textContent = highRisk;
      }
      
      // Weekly stats
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      const weeklySessions = allSessions.filter(session => {
        const sessionDate = new Date(session.content.session.start);
        return sessionDate >= oneWeekAgo;
      });
      
      let totalPenalties = 0;
      let screenRecordingCount = 0;
      let totalDuration = 0;
      let penaltyTypes = {};
      
      weeklySessions.forEach(session => {
        if (session.content.behavior_analysis) {
          totalPenalties += session.content.behavior_analysis.length;
          session.content.behavior_analysis.forEach(behavior => {
            penaltyTypes[behavior.description] = (penaltyTypes[behavior.description] || 0) + 1;
          });
        }
        
        if (session.content.screen_recording_detected) {
          screenRecordingCount++;
        }
        
        totalDuration += session.content.session.duration_seconds;
      });
      
      document.getElementById('weeklyPenalties').textContent = totalPenalties;
      document.getElementById('weeklyScreenRecording').textContent = screenRecordingCount;
      
      if (weeklySessions.length > 0) {
        const avgDuration = (totalDuration / weeklySessions.length).toFixed(2);
        document.getElementById('weeklyAvgDuration').textContent = `${avgDuration}s`;
      }
      
      // Find most common penalty
      let mostCommonPenalty = 'None';
      let maxCount = 0;
      for (const [penalty, count] of Object.entries(penaltyTypes)) {
        if (count > maxCount) {
          mostCommonPenalty = penalty;
          maxCount = count;
        }
      }
      document.getElementById('weeklyCommonPenalty').textContent = mostCommonPenalty;
      
      // Monthly stats
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
      const monthlySessions = allSessions.filter(session => {
        const sessionDate = new Date(session.content.session.start);
        return sessionDate >= oneMonthAgo;
      });
      
      document.getElementById('monthlySessions').textContent = monthlySessions.length;
      
      // Find most used device
      const deviceCounts = {};
      monthlySessions.forEach(session => {
        const deviceKey = `${session.content.device.brand} ${session.content.device.model}`;
        deviceCounts[deviceKey] = (deviceCounts[deviceKey] || 0) + 1;
      });
      
      let topDevice = 'None';
      let maxDeviceCount = 0;
      for (const [device, count] of Object.entries(deviceCounts)) {
        if (count > maxDeviceCount) {
          topDevice = device;
          maxDeviceCount = count;
        }
      }
      document.getElementById('monthlyTopDevice').textContent = topDevice;
      
      // Calculate trust score trend
      if (monthlySessions.length > 0) {
        const firstHalf = monthlySessions.slice(0, Math.floor(monthlySessions.length / 2));
        const secondHalf = monthlySessions.slice(Math.floor(monthlySessions.length / 2));
        
        let firstHalfTrust = 0;
        firstHalf.forEach(session => {
          firstHalfTrust += parseFloat(session.content.session.trust_score);
        });
        firstHalfTrust = firstHalf.length > 0 ? firstHalfTrust / firstHalf.length : 0;
        
        let secondHalfTrust = 0;
        secondHalf.forEach(session => {
          secondHalfTrust += parseFloat(session.content.session.trust_score);
        });
        secondHalfTrust = secondHalf.length > 0 ? secondHalfTrust / secondHalf.length : 0;
        
        const trend = ((secondHalfTrust - firstHalfTrust) / firstHalfTrust * 100).toFixed(2);
        document.getElementById('monthlyTrustTrend').textContent = `${trend > 0 ? '+' : ''}${trend}%`;
        document.getElementById('monthlyTrustTrend').style.color = trend >= 0 ? 'var(--success)' : 'var(--danger)';
      }
      
      // Count unique locations
      const locations = new Set();
      monthlySessions.forEach(session => {
        if (session.content.location) {
          const locationKey = `${session.content.location.latitude.toFixed(2)},${session.content.location.longitude.toFixed(2)}`;
          locations.add(locationKey);
        }
      });
      document.getElementById('monthlyGeoDistribution').textContent = `${locations.size} locations`;
    }

    // Load sessions table
    function loadSessionsTable(filtered = false) {
      const sessionsToDisplay = filtered ? filteredSessions : allSessions;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, sessionsToDisplay.length);
      const paginatedSessions = sessionsToDisplay.slice(startIndex, endIndex);
      
      const tableBody = document.getElementById('sessionsTableBody');
      tableBody.innerHTML = '';
      
      paginatedSessions.forEach((session, index) => {
        const trustScore = parseFloat(session.content.session.trust_score);
        let statusClass = 'normal';
        let statusText = 'Normal';
        let statusIcon = '🟢';
        
        if (trustScore < 70) {
          statusClass = 'alert';
          statusText = 'High Risk';
          statusIcon = '🔴';
        } else if (trustScore < 85) {
          statusClass = 'warning';
          statusText = 'Medium Risk';
          statusIcon = '🟡';
        }
        
        const sessionDate = new Date(session.content.session.start);
        const formattedDate = sessionDate.toLocaleDateString();
        const formattedTime = sessionDate.toLocaleTimeString();
        
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
        row.style.transition = 'var(--transition)';
        row.innerHTML = `
          <td style="padding: 12px 15px;">${session.filename}</td>
          <td style="padding: 12px 15px;">
            <div>${session.content.device.brand} ${session.content.device.model}</div>
            <div style="font-size: 12px; color: var(--gray);">${session.content.device.platform}</div>
          </td>
          <td style="padding: 12px 15px;">${session.content.device.platform}</td>
          <td style="padding: 12px 15px;">
            <div style="font-weight: 600; color: ${trustScore >= 85 ? 'var(--success)' : trustScore >= 70 ? 'var(--warning)' : 'var(--danger)'}">
              ${trustScore}
            </div>
          </td>
          <td style="padding: 12px 15px;">
            ${session.content.session.duration_seconds}s
          </td>
          <td style="padding: 12px 15px;">
            <div>${formattedDate}</div>
            <div style="font-size: 12px; color: var(--gray);">${formattedTime}</div>
          </td>
          <td style="padding: 12px 15px;">
            <button class="btn btn-outline btn-sm view-session-btn" data-index="${startIndex + index}" style="padding: 4px 8px; font-size: 12px;">
              <span class="material-icons" style="font-size: 16px;">visibility</span>
              View
            </button>
          </td>
        `;
        
        tableBody.appendChild(row);
      });
      
      // Update counters
      document.getElementById('showingCount').textContent = `${startIndex + 1}-${endIndex}`;
      document.getElementById('totalCount').textContent = sessionsToDisplay.length;
      
      // Update pagination buttons
      document.getElementById('prevPageBtn').disabled = currentPage === 1;
      document.getElementById('nextPageBtn').disabled = endIndex >= sessionsToDisplay.length;
      
      // Add event listeners to view buttons
      document.querySelectorAll('.view-session-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const sessionIndex = parseInt(this.dataset.index);
          const session = sessionsToDisplay[sessionIndex];
          if (session) {
            showSessionDetails(session);
          }
        });
      });
    }

    // Render session cards
    function renderSessionCards(sessions) {
      const container = document.getElementById('sessionCardsContainer');
      container.innerHTML = '';
      
      // Sort by most recent session first
      const sortedSessions = [...sessions].sort((a, b) => new Date(b.content.session.start) - new Date(a.content.session.start));
      
      // Limit to 10 most recent sessions
      const recentSessions = sortedSessions.slice(0, 10);
      
      recentSessions.forEach((session, index) => {
        const trustScore = parseFloat(session.content.session.trust_score);
        let statusClass = 'normal';
        let statusText = 'Normal';
        let statusIcon = '🟢';
        
        if (trustScore < 70) {
          statusClass = 'alert';
          statusText = 'High Risk';
          statusIcon = '🔴';
        } else if (trustScore < 85) {
          statusClass = 'warning';
          statusText = 'Medium Risk';
          statusIcon = '🟡';
        }
        
        // Format session time
        const sessionStart = new Date(session.content.session.start);
        const sessionEnd = new Date(session.content.session.end);
        const formattedDate = sessionStart.toLocaleDateString();
        const formattedStartTime = sessionStart.toLocaleTimeString();
        const formattedEndTime = sessionEnd.toLocaleTimeString();
        
        // Create heatmap cells for tap durations
        const tapDurations = session.content.tap_durations_ms || [];
        const heatmapCells = Array(5).fill().map((_, i) => {
          if (i < tapDurations.length) {
            const duration = tapDurations[i];
            let bgColor = '#4caf50';
            let opacity = 0.3;
            let trend = '';
            
            if (duration > 600) {
              bgColor = '#ff9800';
              opacity = 0.6;
              trend = '<span class="heatmap-trend" style="color: #ff9800;">↑</span>';
            }
            if (duration > 1000) {
              bgColor = '#f44336';
              opacity = 1.0;
              trend = '<span class="heatmap-trend" style="color: #f44336;">↑↑</span>';
            }
            
            return `<div class="heatmap-cell" style="background: ${bgColor}; opacity: ${opacity};">${duration}ms${trend}</div>`;
          } else {
            return `<div class="heatmap-cell" style="background: #eee; opacity: 0.3;">N/A</div>`;
          }
        }).join('');
        
        // Create timeline items for behavior events
        let timelineItems = '';
        if (session.content.behavior_analysis && session.content.behavior_analysis.length > 0) {
          timelineItems = session.content.behavior_analysis.map(behavior => {
            const behaviorTime = new Date(behavior.timestamp);
            return `
              <div class="timeline-item">
                <div class="timeline-time">${behaviorTime.toLocaleTimeString()}</div>
                <div class="timeline-content">
                  <div class="timeline-action">${behavior.description}</div>
                  <div class="timeline-details">
                    <div class="timeline-detail">Penalty: ${behavior.penalty}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          timelineItems = `
            <div class="timeline-item">
              <div class="timeline-time">${sessionStart.toLocaleTimeString()}</div>
              <div class="timeline-content">
                <div class="timeline-action">No behavioral penalties</div>
                <div class="timeline-details">
                  <div class="timeline-detail">Good session</div>
                </div>
              </div>
            </div>
          `;
        }
        
        // Calculate gauge offset
        const gaugeOffset = 314 * (trustScore / 100);
        
        // Create session card
        const card = document.createElement('div');
        card.className = `user-card ${statusClass}`;
        card.style.animationDelay = `${index * 0.05}s`;
        card.dataset.filename = session.filename;
        card.innerHTML = `
          <div class="user-header">
            <div class="user-title">
              ${session.content.device.brand} ${session.content.device.model}
              <span class="user-status ${statusClass}">
                <span class="status-icon">${statusIcon}</span>
                ${statusText}
              </span>
            </div>
            <div class="user-meta">
              <span class="material-icons">schedule</span>
              <span>${formattedDate} | ${formattedStartTime} - ${formattedEndTime}</span>
            </div>
          </div>
          <div class="user-body">
            <div>
              <div class="user-stats">
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.device.platform}</div>
                  <div class="user-stat-label">Platform</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.device.version}</div>
                  <div class="user-stat-label">OS Version</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.session.duration_seconds}s</div>
                  <div class="user-stat-label">Duration</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.tap_events ? session.content.tap_events.length : 0}</div>
                  <div class="user-stat-label">Tap Events</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.swipe_events ? session.content.swipe_events.length : 0}</div>
                  <div class="user-stat-label">Swipe Events</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${session.content.behavior_analysis ? session.content.behavior_analysis.length : 0}</div>
                  <div class="user-stat-label">Penalties</div>
                </div>
              </div>
              <div>
                <h4>Tap Durations</h4>
                <div class="heatmap">
                  ${heatmapCells}
                </div>
              </div>
              ${session.content.location ? `
                <div class="user-location-map" id="map-${session.filename.replace('.', '-')}"></div>
              ` : ''}
            </div>
            <div>
              <div style="text-align: center;">
                <div class="risk-gauge ${trustScore >= 85 ? 'low-risk' : ''}">
                  <svg width="100%" height="100%" viewBox="0 0 120 120">
                    <circle class="gauge-bg" cx="60" cy="60" r="50"></circle>
                    <circle class="gauge-fill" cx="60" cy="60" r="50" stroke-dasharray="314" stroke-dashoffset="${314 - gaugeOffset}"></circle>
                  </svg>
                  <div class="gauge-text">${trustScore}</div>
                </div>
                <div class="gauge-label">Trust Score</div>
              </div>
              <div class="timeline">
                ${timelineItems}
              </div>
            </div>
          </div>
        `;
        
        // Add click event to show details
        card.addEventListener('click', () => {
          showSessionDetails(session);
        });
        
        container.appendChild(card);

        // Initialize Leaflet map if location data exists
        if (session.content.location) {
          const mapId = `map-${session.filename.replace('.', '-')}`;
          // Wait for the card to be rendered before initializing the map
          setTimeout(() => {
            const mapElement = document.getElementById(mapId);
            if (mapElement) {
              const map = L.map(mapId, {
                zoomControl: false,
                attributionControl: false
              }).setView([session.content.location.latitude, session.content.location.longitude], 13);

              L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
              
              L.marker([session.content.location.latitude, session.content.location.longitude]).addTo(map)
                .bindPopup(`Session location: ${session.content.location.latitude.toFixed(4)}, ${session.content.location.longitude.toFixed(4)}`);
            }
          }, 100);
        }
      });
    }

    // Show session details modal
    function showSessionDetails(session) {
      const modal = document.getElementById('sessionModal');
      const jsonViewer = document.getElementById('sessionJsonViewer');
      
      // Update modal title
      document.querySelector('.modal-title').textContent = `Session Details: ${session.filename}`;
      
      // Format JSON with syntax highlighting
      const formattedJson = JSON.stringify(session.content, null, 2)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
          let cls = 'number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'key';
            } else {
              cls = 'string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'boolean';
          } else if (/null/.test(match)) {
            cls = 'null';
          }
          return `<span class="${cls}">${match}</span>`;
        });
      
      jsonViewer.innerHTML = formattedJson;
      modal.style.display = 'block';
      
      // Add style for syntax highlighting
      const style = document.createElement('style');
      style.textContent = `
        .json-viewer .string { color: #5a8ec9; }
        .json-viewer .number { color: #ff9800; }
        .json-viewer .boolean { color: #f44336; }
        .json-viewer .null { color: #f44336; }
        .json-viewer .key { color: #2c5aa0; }
      `;
      jsonViewer.appendChild(style);
    }

    // Close modal
    function closeModal() {
      document.getElementById('sessionModal').style.display = 'none';
      document.querySelector('.modal-title').textContent = 'Session Details';
    }

    // Filter sessions
    function filterSessions() {
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const trustScoreThreshold = parseInt(document.getElementById('trustScoreRange').value);
      const platformType = document.getElementById('platformType').value;
      const riskLevel = document.getElementById('riskLevel').value;
      
      filteredSessions = allSessions.filter(session => {
        // Filter by date range
        if (dateFrom || dateTo) {
          const sessionDate = new Date(session.content.session.start).toISOString().split('T')[0];
          if (dateFrom && sessionDate < dateFrom) return false;
          if (dateTo && sessionDate > dateTo) return false;
        }
        
        // Filter by trust score
        const trustScore = parseFloat(session.content.session.trust_score);
        if (trustScore > trustScoreThreshold) return false;
        
        // Filter by platform
        if (platformType && session.content.device.platform !== platformType) return false;
        
        // Filter by risk level
        if (riskLevel) {
          if (riskLevel === 'low' && trustScore < 85) return false;
          if (riskLevel === 'medium' && (trustScore >= 85 || trustScore < 70)) return false;
          if (riskLevel === 'high' && trustScore >= 70) return false;
        }
        
        return true;
      });
      
      renderSessionCards(filteredSessions);
      document.getElementById('advancedFilters').classList.remove('active');
    }

    // Filter sessions for table view
    function filterSessionsTable() {
      const dateFrom = document.getElementById('sessionsDateFrom').value;
      const dateTo = document.getElementById('sessionsDateTo').value;
      const trustScoreThreshold = parseInt(document.getElementById('sessionsTrustScoreRange').value);
      const platform = document.getElementById('sessionsPlatform').value;
      const durationFrom = parseInt(document.getElementById('durationFrom').value) || 0;
      const durationTo = parseInt(document.getElementById('durationTo').value) || Number.MAX_SAFE_INTEGER;
      
      filteredSessions = allSessions.filter(session => {
        // Filter by date range
        if (dateFrom || dateTo) {
          const sessionDate = new Date(session.content.session.start).toISOString().split('T')[0];
          if (dateFrom && sessionDate < dateFrom) return false;
          if (dateTo && sessionDate > dateTo) return false;
        }
        
        // Filter by trust score
        const trustScore = parseFloat(session.content.session.trust_score);
        if (trustScore > trustScoreThreshold) return false;
        
        // Filter by platform
        if (platform && session.content.device.platform !== platform) return false;
        
        // Filter by duration
        if (session.content.session.duration_seconds < durationFrom || session.content.session.duration_seconds > durationTo) return false;
        
        return true;
      });
      
      currentPage = 1;
      loadSessionsTable(true);
      document.getElementById('sessionsAdvancedFilters').classList.remove('active');
    }

    // Export session data
    function exportSessionData() {
      Swal.fire({
        title: 'Export Sessions',
        text: 'Would you like to export all sessions or just the filtered ones?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Filtered Sessions',
        cancelButtonText: 'All Sessions',
        showDenyButton: true,
        denyButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // Export filtered sessions
          const dataStr = JSON.stringify(filteredSessions, null, 2);
          downloadJson(dataStr, `phishsafe-filtered-sessions-${new Date().toISOString()}.json`);
        } else if (result.isDismissed) {
          // Export all sessions
          const dataStr = JSON.stringify(allSessions, null, 2);
          downloadJson(dataStr, `phishsafe-all-sessions-${new Date().toISOString()}.json`);
        }
      });
    }

    // Export sessions table data
    function exportSessionsTableData() {
      const sessionsToExport = filteredSessions.length > 0 ? filteredSessions : allSessions;
      
      Swal.fire({
        title: 'Export Sessions',
        text: `Preparing to export ${sessionsToExport.length} sessions. Continue?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Export',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          const dataStr = JSON.stringify(sessionsToExport, null, 2);
          downloadJson(dataStr, `phishsafe-sessions-${new Date().toISOString()}.json`);
        }
      });
    }

    // Download JSON file
    function downloadJson(dataStr, filename) {
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', filename);
      linkElement.click();
    }

    // Set up event listeners
    function setupEventListeners() {
      // Search functionality with debounce
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const searchTerm = e.target.value.toLowerCase();
          filteredSessions = allSessions.filter(session => 
            session.filename.toLowerCase().includes(searchTerm) ||
            session.content.device.brand.toLowerCase().includes(searchTerm) ||
            session.content.device.model.toLowerCase().includes(searchTerm) ||
            session.content.device.platform.toLowerCase().includes(searchTerm) ||
            session.content.session.trust_score.includes(searchTerm)
          );
          renderSessionCards(filteredSessions);
        }, 300);
      });
      
      // Auto-refresh toggle
      document.getElementById('autoRefreshBtn').addEventListener('click', function() {
        this.classList.toggle('active');
        if (this.classList.contains('active')) {
          startAutoRefresh();
        } else {
          stopAutoRefresh();
        }
      });
      
      // Filter buttons
      document.getElementById('filterBtn').addEventListener('click', function() {
        document.getElementById('advancedFilters').classList.toggle('active');
      });
      
      document.getElementById('sessionsFilterBtn').addEventListener('click', function() {
        document.getElementById('sessionsAdvancedFilters').classList.toggle('active');
      });
      
      // Apply filters
      document.getElementById('applyFilters').addEventListener('click', filterSessions);
      document.getElementById('sessionsApplyFilters').addEventListener('click', filterSessionsTable);
      
      // Reset filters
      document.getElementById('resetFilters').addEventListener('click', function() {
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        document.getElementById('trustScoreRange').value = 70;
        document.getElementById('trustScoreValue').textContent = '70+';
        document.getElementById('platformType').value = '';
        document.getElementById('riskLevel').value = '';
        
        filteredSessions = [...allSessions];
        renderSessionCards(filteredSessions);
        document.getElementById('advancedFilters').classList.remove('active');
      });
      
      document.getElementById('sessionsResetFilters').addEventListener('click', function() {
        document.getElementById('sessionsDateFrom').value = '';
        document.getElementById('sessionsDateTo').value = '';
        document.getElementById('sessionsTrustScoreRange').value = 70;
        document.getElementById('sessionsTrustScoreValue').textContent = '70+';
        document.getElementById('sessionsPlatform').value = '';
        document.getElementById('durationFrom').value = '';
        document.getElementById('durationTo').value = '';
        
        filteredSessions = [...allSessions];
        currentPage = 1;
        loadSessionsTable();
        document.getElementById('sessionsAdvancedFilters').classList.remove('active');
      });
      
      // Trust score range input
      document.getElementById('trustScoreRange').addEventListener('input', function() {
        document.getElementById('trustScoreValue').textContent = `${this.value}+`;
      });
      
      document.getElementById('sessionsTrustScoreRange').addEventListener('input', function() {
        document.getElementById('sessionsTrustScoreValue').textContent = `${this.value}+`;
      });
      
      // Export buttons
      document.getElementById('exportBtn').addEventListener('click', exportSessionData);
      document.getElementById('sessionsExportBtn').addEventListener('click', exportSessionsTableData);
      
      // Modal close buttons
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('closeModalBtn').addEventListener('click', closeModal);
      
      // Copy JSON button
      document.getElementById('copyJsonBtn').addEventListener('click', function() {
        const jsonViewer = document.getElementById('sessionJsonViewer');
        const textToCopy = jsonViewer.textContent;
        
        navigator.clipboard.writeText(textToCopy).then(() => {
          Swal.fire({
            title: 'Copied!',
            text: 'Session JSON has been copied to clipboard.',
            icon: 'success',
            timer: 2000
          });
        });
      });
      
      // Pagination buttons
      document.getElementById('prevPageBtn').addEventListener('click', function() {
        if (currentPage > 1) {
          currentPage--;
          loadSessionsTable(filteredSessions.length > 0);
        }
      });
      
      document.getElementById('nextPageBtn').addEventListener('click', function() {
        const totalPages = Math.ceil((filteredSessions.length > 0 ? filteredSessions : allSessions).length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          loadSessionsTable(filteredSessions.length > 0);
        }
      });
      
      // Select all button
      document.getElementById('selectAllBtn').addEventListener('click', function() {
        const sessionsToSelect = filteredSessions.length > 0 ? filteredSessions : allSessions;
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, sessionsToSelect.length);
        
        for (let i = startIndex; i < endIndex; i++) {
          selectedSessions.add(sessionsToSelect[i].filename);
        }
        
        loadSessionsTable(filteredSessions.length > 0);
      });
      
      // Generate report button
      document.getElementById('generateReportBtn').addEventListener('click', function() {
        Swal.fire({
          title: 'Generating Report',
          text: 'Your report is being prepared...',
          icon: 'info',
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          Swal.fire({
            title: 'Report Ready!',
            text: 'Your report has been generated successfully.',
            icon: 'success'
          });
        });
      });
      
      // Schedule report button
      document.getElementById('scheduleReportBtn').addEventListener('click', function() {
        Swal.fire({
          title: 'Schedule Report',
          html: `
            <select id="swal-input1" class="swal2-input">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
            <input type="time" id="swal-input2" class="swal2-input" value="09:00">
          `,
          focusConfirm: false,
          preConfirm: () => {
            return [
              document.getElementById('swal-input1').value,
              document.getElementById('swal-input2').value
            ]
          }
        }).then((result) => {
          if (result.isConfirmed) {
            Swal.fire({
              title: 'Report Scheduled!',
              text: `Your report has been scheduled for ${result.value[0]} delivery at ${result.value[1]}.`,
              icon: 'success'
            });
          }
        });
      });
    }

    // Set up keyboard shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Focus search bar when / is pressed
        if (e.key === '/' && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          document.getElementById('searchInput').focus();
        }
        
        // Toggle theme when T is pressed
        if (e.key.toLowerCase() === 't' && !e.target.matches('input, textarea, select')) {
          e.preventDefault();
          themeToggle.click();
        }
        
        // Close modal when Escape is pressed
        if (e.key === 'Escape' && document.getElementById('sessionModal').style.display === 'block') {
          closeModal();
        }
        
        // Show help when ? is pressed
        if (e.key === '?') {
          e.preventDefault();
          Swal.fire({
            title: 'Keyboard Shortcuts',
            html: `
              <div style="text-align: left;">
                <p><strong>/</strong> - Focus search bar</p>
                <p><strong>T</strong> - Toggle dark mode</p>
                <p><strong>Esc</strong> - Close modal</p>
                <p><strong>?</strong> - Show this help</p>
              </div>
            `,
            icon: 'info'
          });   
        }
      });
    }

    // Auto-refresh functions
    function startAutoRefresh() {
      stopAutoRefresh(); // Clear any existing interval
      autoRefreshInterval = setInterval(loadSessionData, 30000);
      document.getElementById('autoRefreshBtn').classList.add('pulse');
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      document.getElementById('autoRefreshBtn').classList.remove('pulse');
    }
  </script>
</body>
</html>